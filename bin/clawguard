#!/usr/bin/env node

/**
 * ClawGuard CLI
 * Security blacklist checker for AI agents
 *
 * Usage:
 *   clawguard check <input>          Check any input (auto-detects type)
 *   clawguard url <url>              Check a URL
 *   clawguard command <cmd>          Check a command
 *   clawguard skill <name> [author]  Check a skill
 *   clawguard message <text>         Check a message for scams/injection
 *   clawguard stats                  Show audit statistics
 *   clawguard sync                   Sync blacklist database
 */

import { check, checkUrl, checkCommand, checkSkill } from '../lib/index.js';
import { getDetector, RESULT, EXIT_CODE } from '../lib/detector.js';
import { readAudit, getAuditStats } from '../lib/audit.js';
import { loadConfig } from '../lib/config.js';

const args = process.argv.slice(2);
const command = args[0];

function usage() {
    console.log(`ClawGuard — Security blacklist for AI agents

Usage:
  clawguard check <input>            Auto-detect and check input
  clawguard url <url>                Check a URL for threats
  clawguard command <cmd>            Check a shell command
  clawguard skill <name> [author]    Check a skill name
  clawguard message <text>           Check message for scams/injection
  clawguard stats                    Show audit statistics
  clawguard version                  Show version

Options:
  --json                             Output as JSON
  --quiet                            Only output exit code (0=safe, 1=block, 2=warn)
`);
}

function formatResult(result, jsonMode) {
    if (jsonMode) {
        console.log(JSON.stringify(result, null, 2));
    } else {
        console.log(result.message);
        if (result.matches?.length > 0) {
            for (const m of result.matches) {
                console.log(`  → ${m.matched_type}: ${m.matched_value || ''} (confidence: ${m.confidence || 'n/a'})`);
                if (m.category) console.log(`    category: ${m.category}`);
            }
        }
        console.log(`  Duration: ${result.duration_ms?.toFixed(1)}ms`);
    }
}

async function main() {
    if (!command || command === '--help' || command === '-h') {
        usage();
        process.exit(0);
    }

    const jsonMode = args.includes('--json');
    const quiet = args.includes('--quiet');
    const filteredArgs = args.filter(a => !a.startsWith('--'));

    await loadConfig();

    try {
        let result;

        switch (command) {
            case 'check': {
                const input = filteredArgs.slice(1).join(' ');
                if (!input) { console.error('Error: missing input'); process.exit(3); }
                result = await check(input);
                break;
            }
            case 'url': {
                const url = filteredArgs[1];
                if (!url) { console.error('Error: missing URL'); process.exit(3); }
                result = await checkUrl(url);
                break;
            }
            case 'command': {
                const cmd = filteredArgs.slice(1).join(' ');
                if (!cmd) { console.error('Error: missing command'); process.exit(3); }
                const detector = getDetector();
                result = await detector.checkCommand(cmd);
                break;
            }
            case 'skill': {
                const name = filteredArgs[1];
                const author = filteredArgs[2];
                if (!name) { console.error('Error: missing skill name'); process.exit(3); }
                const detector = getDetector();
                result = await detector.checkSkill(name, author);
                break;
            }
            case 'message': {
                const msg = filteredArgs.slice(1).join(' ');
                if (!msg) { console.error('Error: missing message'); process.exit(3); }
                const detector = getDetector();
                result = await detector.checkMessage(msg);
                break;
            }
            case 'stats': {
                const stats = getAuditStats();
                if (jsonMode) {
                    console.log(JSON.stringify(stats, null, 2));
                } else {
                    console.log('ClawGuard Audit Stats:');
                    for (const [k, v] of Object.entries(stats)) {
                        console.log(`  ${k}: ${v}`);
                    }
                }
                process.exit(0);
                break;
            }
            case 'version': {
                const pkg = await import('../package.json', { with: { type: 'json' } });
                console.log(`clawguard v${pkg.default.version}`);
                process.exit(0);
                break;
            }
            default:
                console.error(`Unknown command: ${command}`);
                usage();
                process.exit(3);
        }

        if (!quiet) formatResult(result, jsonMode);
        process.exit(result.exitCode);

    } catch (err) {
        if (!quiet) console.error(`Error: ${err.message}`);
        process.exit(3);
    }
}

main();
